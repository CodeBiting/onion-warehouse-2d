doctype html
html(lang="en")
    head
        meta(charset="UTF-8")
        title 2D Map with Pixi.js
        script(src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/6.5.4/browser/pixi.min.js" integrity="sha512-MLJM72M8frjnFXEvWn3NaVkrSxlDnbRK/Iwyr7loPca+13SdS9B5sNLHoIkDxfPOndP8WReNdwGLxisYUapc7A==" crossorigin="anonymous" referrerpolicy="no-referrer")
        script(src="https://cdn.jsdelivr.net/npm/pixi-viewport@4.30.0/dist/viewport.min.js")
        style.
            body {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 10px;
                font-family: Arial, sans-serif;
                background-color: #f0f0f0;
                margin: 0;
                padding: 0;
                height: 100vh;
                box-sizing: border-box;
            }

            #header {
                text-align: center;
                margin-top: 20px;
            }

            #main-container {
                display: flex;
                flex-direction: column;
                gap: 20px;
                width: 90%;
                margin-top: 20px;
                flex: 1;
            }

            @media (min-width: 768px) {
                #main-container {
                    flex-direction: row;
                }
            }

            #left-panel {
                display: flex;
                flex-direction: column;
                gap: 10px;
                flex: 1;
                position: relative;
            }

            #right-panel {
                flex: 2;
                display: flex;
                flex-direction: column;
                margin-top: 5%;
                align-items: center;
                margin-bottom: 5%;
            }

            #autocomplete-container {
                position: relative;
                width: 100%;
            }

            #autocomplete-results {
                position: absolute;
                width: 100%;
                top: 35px;
                left: 0;
                right: 0;
                z-index: 1000;
                border: 1px solid #ddd;
                background: #fff;
                list-style-type: none;
                padding: 0;
                margin: 0;
                max-height: 120px;
                overflow-y: auto;
            }

            #autocomplete-results li {
                padding: 5px 10px;
                cursor: pointer;
            }

            #autocomplete-results li:hover {
                background-color: #f0f0f0;
            }

            #buttons {
                display: flex;
                gap: 10px;
                margin-top: 15px;
                flex-wrap: wrap;
            }

            #location-details {

                max-height: 400px;
                overflow-y: auto;
                border: 3px solid #ccc;
                padding: 10px;
                background-color: #fff;
                margin-top: 20px;
            }

            #location-details table {
                width: 100%;
                border-collapse: collapse;
            }

            #location-details th, #location-details td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
            }

            #location-details tr:nth-child(even) {
                background-color: #f2f2f2;
            }

            #location-details th {
                background-color: #4CAF50;
                color: white;
            }

            #pixi-canvas-container {
                display: flex;
                flex-direction: column;
                align-items: center;
                width: 100%;
                margin-top: 20px;
                flex: 1;
            }

            canvas {
                width: 100%;
                height: auto;
                max-width: 800px;
                max-height: 500px;
                transition: width 0.5s, height 0.5s;
            }


    body
        #header
            h1 Warehouse Map

        #main-container
            #left-panel
                #autocomplete-container
                    input(type="text" id="productCode" placeholder="Enter product code" oninput="autocompleteSearch()")
                    ul#autocomplete-results
                #buttons
                    button(onclick="searchProduct()") Search
                    button#zoomIn Zoom In
                    button#zoomOut Zoom Out
                #location-details
                    table
                        thead
                            tr
                                th Location Code
                                th Parent Code
                                th Position
                                th Inside
                        tbody

            #right-panel
                #pixi-canvas-container


        script.
            const transformedData = !{JSON.stringify(data)};
            const products = !{JSON.stringify(productsData)};
            const stocks = !{JSON.stringify(stocksData)};
            console.log(transformedData);

            const app = new PIXI.Application({
                width: 600,
                height: 300,
                backgroundColor: 0xffffff,
            });
            const canvasContainer = document.getElementById('pixi-canvas-container');
            canvasContainer.appendChild(app.view);

            app.view.style.border = '4px solid #000000';

            const viewport = new PIXI.Viewport({
                screenWidth: 600,
                screenHeight: 300,
                worldWidth: 1000,
                worldHeight: 600,
                interaction: app.renderer.plugins.interaction
            });

            app.stage.addChild(viewport);

            viewport.drag().pinch().wheel().decelerate();

            const mapContainer = new PIXI.Container();
            viewport.addChild(mapContainer);

            function createSquare (x, z, highlight = false, color = 0xffffff) {
                const square = new PIXI.Container();
                square.x = x * 25;
                square.y = z * 25;
                square.interactive = true;
                square.on('pointerdown', () => displayInfo(x, z));

                if (color !== 0xffffff) {
                    const graphics = new PIXI.Graphics();
                    graphics.beginFill(color, 1);
                    graphics.drawRect(0, 0, 25, 25);
                    graphics.endFill();
                    square.addChild(graphics);
                }

                if (highlight) {
                    const highlightOverlay = new PIXI.Graphics();
                    highlightOverlay.beginFill(0xffeb3b, 0.5);
                    highlightOverlay.drawRect(0, 0, 25, 25);
                    highlightOverlay.endFill();
                    square.addChild(highlightOverlay);
                } else {
                    const image = new PIXI.Sprite.from('/images/thumbnail_icona-estanteria-2.png');
                    image.width = 25;
                    image.height = 25;
                    square.addChild(image);
                }

                return square;
            }

            function createTiles () {
                transformedData.filter(item => item.typeId === 6).forEach((locationGroup) => {
                    locationGroup.locations.forEach((location) => {
                        const square = createSquare(location.x, location.z, false, 0xffffff);
                        mapContainer.addChild(square);
                    });
                });

                const users = transformedData.filter(item => item.placeTypeCode === "User");
                console.log('Users:', users);
                users.forEach((user) => {
                    const color = 0x00ff00;
                    const square = createSquare(user.x, user.z, "user", color);
                    mapContainer.addChild(square);
                });

                transformedData.filter(item => item.placeTypeCode === "Dock").forEach((dock) => {
                    const color = 0xff0000;
                    const square = createSquare(dock.x, dock.z, "dock", color);
                    mapContainer.addChild(square);
                });

                transformedData.filter(item => item.placeTypeCode === "Buffer").forEach((buffer) => {
                    const color = 0xff8000;
                    const square = createSquare(buffer.x, buffer.z, "buffer", color);
                    mapContainer.addChild(square);
                });
            }

            function isUser (x, z) {
                for (const item of transformedData) {
                    if (item.placeTypeCode === "User" && item.x === x && item.z === z) {
                        return true;
                    }
                }
                return false;
            }

            function isLocation (x, z) {
                for (const item of transformedData) {
                    if (Array.isArray(item.locations)) {
                        if (item.locations.some(location => location.x === x && location.z === z)) {
                            return true;
                        }
                    }
                }
                return false;
            }

            function isBuffer (x, z) {
                for (const item of transformedData) {
                    if (item.placeTypeCode === "Buffer" && item.x === x && item.z === z) {
                        return true;
                    }
                }
                return false;
            }

            function isDock (x, z) {
                for (const item of transformedData) {
                    if (item.placeTypeCode === "Dock" && item.x === x && item.z === z) {
                        return true;
                    }
                }
                return false;
            }

            function displayInfo (x, z) {
                const isUserSquare = isUser(x, z);
                const isLocationSquare = isLocation(x, z);

                switch (true) {
                    case isUserSquare:
                        elementType = "User";
                        displayUserInfo();
                        break;
                    case isLocationSquare:
                        elementType = "Location";
                        displayLocationInfo(x, z);
                        break;
                    default:
                        console.log("No information available for this element.");
                }
            }

            function displayUserInfo () {
                const locationDetails = document.getElementById('location-details');
                locationDetails.innerHTML = '';
                const message = document.createElement('p');
                message.textContent = 'No details available for user.';
                locationDetails.appendChild(message);
            }

            function displayLocationInfo (x, z) {
                const locationDetails = document.getElementById('location-details');
                locationDetails.innerHTML = '';

                const table = document.createElement('table');
                const thead = document.createElement('thead');
                const tbody = document.createElement('tbody');
                const trHead = document.createElement('tr');

                const thLocationCode = document.createElement('th');
                thLocationCode.textContent = 'Location Code';
                const thParentCode = document.createElement('th');
                thParentCode.textContent = 'Parent Code';
                const thPosition = document.createElement('th');
                thPosition.textContent = 'Position';
                const thInside = document.createElement('th');
                thInside.textContent = 'Inside';

                trHead.appendChild(thLocationCode);
                trHead.appendChild(thParentCode);
                trHead.appendChild(thPosition);
                trHead.appendChild(thInside);
                thead.appendChild(trHead);
                table.appendChild(thead);
                table.appendChild(tbody);

                transformedData.forEach(item => {
                    if (Array.isArray(item.locations)) {
                        item.locations.forEach(location => {
                            if (location.x === x && location.z === z) {
                                const trBody = document.createElement('tr');

                                const tdLocationCode = document.createElement('td');
                                tdLocationCode.textContent = location.code;
                                const tdParentCode = document.createElement('td');
                                const regex = /^[A-Za-z]\s*\d{6}$/;
                                const isStandardFormat = regex.test(location.code.replace(/\s/g, ''));
                                tdParentCode.textContent = isStandardFormat ? location.code.trim().charAt(0) : location.code;

                                const tdPosition = document.createElement('td');
                                tdPosition.textContent = `| x = ${location.x} | y = ${location.y || 0} | z = ${location.z} |`;

                                const tdInside = document.createElement('td');
                                const locationStocks = stocks.filter(stock => stock.placeId === location.id);
                                if (locationStocks.length > 0) {
                                    locationStocks.forEach(stock => {
                                        const product = products.find(product => product.id === stock.productId);
                                        if (product) {
                                            const productInfo = document.createElement('div');
                                            productInfo.textContent = `${product.name} = ${stock.quantity} Units`;
                                            tdInside.appendChild(productInfo);
                                        }
                                    });
                                } else {
                                    tdInside.textContent = 'No products found.';
                                }

                                trBody.appendChild(tdLocationCode);
                                trBody.appendChild(tdParentCode);
                                trBody.appendChild(tdPosition);
                                trBody.appendChild(tdInside);
                                tbody.appendChild(trBody);
                            }
                        });
                    }
                });

                locationDetails.appendChild(table);
            }


            function findStockByProductId (productId) {
                return stocks.find(stock => stock.productId === productId);
            }

            window.searchProduct = function () {
                const productCode = document.getElementById('productCode').value.trim().toUpperCase();

                let found = false;

                const product = products.find(product => product.code.toUpperCase() === productCode);
                if (product) {
                    found = true;
                    const stock = findStockByProductId(product.id);
                    if (stock) {
                        const location = transformedData.find(item => item.locations && item.locations.some(location => location.id === stock.placeId && location.placeTypeCode === 'Location'));
                        if (location) {
                            console.log(`Product found: ${productCode}. It will be highlighted`);
                            highlightItem(location.x, location.z);
                            displayLocationInfo(location.x, location.z); // Update details section
                        } else {
                            console.log(`Location not found for product: ${productCode}.`);
                        }
                    } else {
                        console.log(`No stock found for product: ${productCode}.`);
                    }
                }

                if (!found) {
                    transformedData.forEach(item => {
                        if (item.code && item.code.toUpperCase() === productCode) {
                            found = true;
                            if (item.placeTypeCode === 'User' || item.placeTypeCode === 'Dock' || item.placeTypeCode === 'Buffer') {
                                console.log(`${productCode}. It will be highlighted`);
                                highlightItem(item.x, item.z);
                                // If you need to update details section for other types, add corresponding functions
                            }
                        } else if (item.locations) {
                            item.locations.forEach(location => {
                                if (location.code && location.code.toUpperCase() === productCode) {
                                    found = true;
                                    console.log(`Location found: ${productCode}. It will be highlighted`);
                                    highlightItem(location.x, location.z);
                                    displayLocationInfo(location.x, location.z); // Update details section
                                }
                            });
                        }
                    });
                }

                if (!found) {
                    console.log(`Product not found: ${productCode}.`);
                }
            };

            window.autocompleteSearch = function () {
                let input = document.getElementById('productCode');
                let filter = input.value.toUpperCase();
                let ul = document.getElementById('autocomplete-results');
                ul.innerHTML = '';

                let suggestions = [];

                products.forEach(product => {
                    if (product.code.toUpperCase().startsWith(filter)) {
                        suggestions.push(product.code);
                    }
                });

                transformedData.forEach(item => {
                    if (item.code && item.code.toUpperCase().startsWith(filter)) {
                        suggestions.push(item.code);
                    }
                    if (Array.isArray(item.locations)) {
                        item.locations.forEach(location => {
                            if (location.code && location.code.toUpperCase().startsWith(filter)) {
                                suggestions.push(location.code);
                            }
                        });
                    }
                });

                suggestions = suggestions.slice(0, 4);

                suggestions.forEach(suggestion => {
                    let li = document.createElement('li');
                    li.textContent = suggestion;
                    li.onclick = function () {
                        input.value = suggestion;
                        ul.innerHTML = '';
                        searchProduct();
                    };
                    ul.appendChild(li);
                });
            };

            function highlightItem (x, z) {
                const highlightColor = 0xffeb3b;
                const square = createSquare(x, z, true); // Pass true for highlighting
                mapContainer.addChild(square);
                viewport.moveCenter(x * 25 + 12.5, z * 25 + 12.5);
            }

            document.addEventListener('click', function (event) {
                const autocompleteList = document.getElementById('autocomplete-results');
                if (!event.target.matches('#productCode')) {
                    autocompleteList.innerHTML = '';
                }
            });

            createTiles();

            const zoomInButton = document.getElementById('zoomIn');
            const zoomOutButton = document.getElementById('zoomOut');

            zoomInButton.addEventListener('click', () => {
                viewport.zoomPercent(0.1);
                console.log('Zoom In clicked');
            });

            zoomOutButton.addEventListener('click', () => {
                viewport.zoomPercent(-0.1);
                console.log('Zoom Out clicked');
            });

